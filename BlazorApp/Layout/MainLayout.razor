@inherits LayoutComponentBase
@using BlazorApp.Auth
@using Blazored.LocalStorage
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Nav
@inject ILocalStorageService LocalStorage
@inject InMemoryUserSession InMemorySession

<div class="app-shell @(isCollapsed ? "collapsed" : "")">
    <aside class="sidebar">
        <div class="sidebar-header">
            <button class="icon-btn menu-toggle" @onclick="ToggleSidebar" title="Menú">
                <span class="bi bi-list"></span>
            </button>
        </div>

        <nav class="sidebar-nav">
            <NavLink class="nav-item" href="/" Match="NavLinkMatch.All">
                <span class="bi bi-house-door"></span>
                <span class="nav-label">Inicio</span>
            </NavLink>

            <NavLink class="nav-item" href="/producto">
                <span class="bi bi-bag"></span>
                <span class="nav-label">Productos</span>
            </NavLink>

            <NavLink class="nav-item" href="/venta">
                <span class="bi bi-receipt"></span>
                <span class="nav-label">Ventas</span>
            </NavLink>

            <NavLink class="nav-item" href="/pedido">
                <span class="bi bi-truck"></span>
                <span class="nav-label">Pedidos</span>
            </NavLink>

            <NavLink class="nav-item" href="/proveedor">
                <span class="bi bi-building"></span>
                <span class="nav-label">Proveedores</span>
            </NavLink>

            <NavLink class="nav-item" href="/persona">
                <span class="bi bi-person-lines-fill"></span>
                <span class="nav-label">Personas</span>
            </NavLink>

            <NavLink class="nav-item" href="/tipo-producto">
                <span class="bi bi-tags"></span>
                <span class="nav-label">Tipos de producto</span>
            </NavLink>

            <NavLink class="nav-item" href="/provincia">
                <span class="bi bi-geo-alt"></span>
                <span class="nav-label">Provincias</span>
            </NavLink>

            <NavLink class="nav-item" href="/localidad">
                <span class="bi bi-geo"></span>
                <span class="nav-label">Localidades</span>
            </NavLink>

            <button type="button"
                    class="nav-item nav-collapsible @(IsStatsActive ? "active" : null)"
                    @onclick="ToggleStats">
                <div class="nav-collapsible-left">
                    <span class="bi bi-graph-up"></span>
                    <span class="nav-label">Estadísticas</span>
                </div>
                <span class="bi bi-chevron-down caret @(statsOpen ? "open" : null)"></span>
            </button>

            <div class="submenu @(statsOpen ? "open" : null)">
                <NavLink class="nav-item sub-item" href="/reporte/precios">
                    <span class="bi bi-activity"></span>
                    <span class="nav-label">Historial de precios</span>
                </NavLink>

                <NavLink class="nav-item sub-item" href="/reporte/ventas">
                    <span class="bi bi-file-earmark-bar-graph"></span>
                    <span class="nav-label">Reporte Ventas</span>
                </NavLink>
            </div>
        </nav>

    </aside>

    <section class="main">
        <header class="topbar">
            <div class="brand-centered" @onclick="@(() => Nav.NavigateTo("/"))" style="cursor: pointer;">
                <img src="inventario.png" alt="Logo" class="brand-logo" />
                <strong class="brand-title">Inventario</strong>
            </div>

            <AuthorizeView>
                <Authorized>
                    <div class="user-area">
                        <span class="text-muted">Hola,</span>
                        <strong>@(context.User.Identity?.Name ?? "Usuario")</strong>
                        <button class="btn btn-outline-danger btn-sm ms-2" @onclick="Logout">
                            <i class="bi bi-box-arrow-right me-1"></i>
                            <span>Salir</span>
                        </button>
                    </div>
                </Authorized>
            </AuthorizeView>
        </header>

        <main class="content">
            @Body
        </main>
    </section>
</div>

@code {

    private bool isCollapsed = false;
    private void ToggleSidebar() => isCollapsed = !isCollapsed;

    private bool statsOpen;
    private bool IsStatsActive =>
        Nav.Uri.Contains("/reporte/precios", StringComparison.OrdinalIgnoreCase) ||
        Nav.Uri.Contains("/reporte/ventas", StringComparison.OrdinalIgnoreCase);

    protected override void OnParametersSet()
    {
        if (IsStatsActive) statsOpen = true;
    }

    private void ToggleStats() => statsOpen = !statsOpen;

    private async Task Logout()
    {
        await LocalStorage.RemoveItemAsync("authToken");
        InMemorySession.Token = null;

        if (AuthStateProvider is CustomAuthenticationStateProvider provider)
            provider.NotifyUserLogout();

        Nav.NavigateTo("/login");
    }
}
