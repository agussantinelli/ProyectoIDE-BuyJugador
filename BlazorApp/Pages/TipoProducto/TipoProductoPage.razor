@page "/tipo-producto"
@attribute [Authorize]

@using ApiClient
@using DTOs
@inject TipoProductoApiClient tipoProductoApiClient
@inject NavigationManager NavigationManager
@inject IJSRuntime JS

<link href="css/Table.css" rel="stylesheet" />

<div class="tbl-container">
    <div class="tbl-header">
        <h2 class="tbl-title">Gestión de Tipos de Producto</h2>

        <div class="tbl-search">
            <span class="bi bi-search tbl-search-icon" aria-hidden="true"></span>
            <input class="tbl-input" type="text" placeholder="Buscar por descripción..."
                   @bind="TextoBusqueda" @bind:event="oninput" />
            <button class="btn btn-primary" @onclick="NuevoTipoProducto">
                <i class="bi bi-plus-circle"></i>
                <span>Nuevo</span>
            </button>
        </div>
    </div>

    @if (tiposProductoFiltrados == null)
    {
        <div class="tbl-state">
            <i class="bi bi-arrow-repeat spin"></i> Cargando tipos de producto...
        </div>
    }
    else if (!tiposProductoFiltrados.Any())
    {
        <div class="tbl-state">
            <i class="bi bi-inbox"></i> No se encontraron tipos de producto.
        </div>
    }
    else
    {
        <div class="tbl-wrapper">
            <table class="tbl table-striped table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Descripción</th>
                        <th class="tbl-actions">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var tipo in tiposProductoFiltrados)
                    {
                        <tr>
                            <td>@tipo.IdTipoProducto</td>
                            <td>@tipo.Descripcion</td>
                            <td class="tbl-actions">
                                <button class="btn-icon" title="Ver productos" @onclick="() => VerProductos(tipo)">
                                    <i class="bi bi-boxes"></i>
                                </button>
                                <button class="btn-icon" title="Editar" @onclick="() => Editar(tipo)">
                                    <i class="bi bi-pencil-square"></i>
                                </button>
                                <button class="btn-icon" title="Eliminar" @onclick="() => AbrirModalConfirmacion(tipo)">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@if (mostrarModalConfirmacion && _tipoProductoParaEliminar != null)
{
    <div class="modal fade show" tabindex="-1" style="display: block;" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirmar Eliminación</h5>
                    <button type="button" class="btn-close" @onclick="CerrarModalConfirmacion" disabled="@eliminando"></button>
                </div>
                <div class="modal-body">
                    <p>
                        ¿Estás seguro de que deseas eliminar el tipo de producto:
                        <strong>@_tipoProductoParaEliminar.Descripcion</strong>?
                    </p>
                    <small class="text-muted d-block">
                        (Si tiene productos asociados, no podrá eliminarse)
                    </small>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CerrarModalConfirmacion" disabled="@eliminando">
                        Cancelar
                    </button>
                    <button type="button" class="btn btn-danger" @onclick="EliminarConfirmado" disabled="@eliminando">
                        @if (eliminando)
                        {
                            <span><i class="bi bi-arrow-repeat spin"></i> Eliminando...</span>
                        }
                        else
                        {
                            <span>Eliminar</span>
                        }
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

@code {
    private List<TipoProductoDTO>? _tiposProducto;
    private List<TipoProductoDTO>? tiposProductoFiltrados;

    private string _textoBusqueda = string.Empty;
    private string TextoBusqueda
    {
        get => _textoBusqueda;
        set { _textoBusqueda = value ?? string.Empty; AplicarFiltro(); }
    }

    private bool mostrarModalConfirmacion = false;
    private bool eliminando = false;
    private TipoProductoDTO? _tipoProductoParaEliminar;

    protected override async Task OnInitializedAsync()
    {
        await CargarTiposProducto();
    }

    private async Task CargarTiposProducto()
    {
        _tiposProducto = await tipoProductoApiClient.GetAllAsync() ?? new();
        AplicarFiltro();
    }

    private void AplicarFiltro()
    {
        if (string.IsNullOrWhiteSpace(TextoBusqueda))
        {
            tiposProductoFiltrados = _tiposProducto;
        }
        else
        {
            var f = TextoBusqueda.Trim();
            tiposProductoFiltrados = _tiposProducto?
                .Where(p => (p.Descripcion ?? string.Empty).Contains(f, StringComparison.OrdinalIgnoreCase))
                .ToList();
        }
        StateHasChanged();
    }

    private void NuevoTipoProducto() => NavigationManager.NavigateTo("/tipo-producto/crear");
    private void Editar(TipoProductoDTO tipo) => NavigationManager.NavigateTo($"/tipo-producto/editar/{tipo.IdTipoProducto}");
    private void VerProductos(TipoProductoDTO tipo) => NavigationManager.NavigateTo($"/tipo-producto/{tipo.IdTipoProducto}/productos");

    private void AbrirModalConfirmacion(TipoProductoDTO tipo)
    {
        _tipoProductoParaEliminar = tipo;
        mostrarModalConfirmacion = true;
    }

    private void CerrarModalConfirmacion()
    {
        if (eliminando) return;
        mostrarModalConfirmacion = false;
        _tipoProductoParaEliminar = null;
        eliminando = false;
    }

    private async Task EliminarConfirmado()
    {
        if (_tipoProductoParaEliminar is null) return;

        eliminando = true;
        try
        {
            await tipoProductoApiClient.DeleteAsync(_tipoProductoParaEliminar.IdTipoProducto);

            _tiposProducto?.RemoveAll(t => t.IdTipoProducto == _tipoProductoParaEliminar.IdTipoProducto);
            AplicarFiltro();

            await JS.InvokeVoidAsync("alert", "✅ Tipo de producto eliminado correctamente.");
        }
        catch (InvalidOperationException ex)
        {
            await JS.InvokeVoidAsync("alert", $"❌ No se puede eliminar: {ex.Message}");
        }
        catch (HttpRequestException ex)
        {
            await JS.InvokeVoidAsync("alert", $"❌ Error de conexión: {ex.Message}");
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"❌ Error inesperado: {ex.Message}");
        }
        finally
        {
            eliminando = false;
            CerrarModalConfirmacion();
        }
    }
}
