@page "/tipo-producto"
@attribute [Authorize]

@using ApiClient
@using DTOs
@inject TipoProductoApiClient tipoProductoApiClient
@inject NavigationManager NavigationManager

<link href="css/Table.css" rel="stylesheet" />

@if (!string.IsNullOrEmpty(_mensaje))
{
    <div class="alert @(_esError ? "alert-danger" : "alert-success")" role="alert">
        @_mensaje
        <button type="button" class="btn-close" @onclick="() => _mensaje = null" aria-label="Close"></button>
    </div>
}

<div class="tbl-container">
    <div class="tbl-header">
        <h2 class="tbl-title">Gestión de Tipos de Producto</h2>

        <div class="tbl-search">
            <span class="bi bi-search tbl-search-icon" aria-hidden="true"></span>
            <input class="tbl-input" type="text" placeholder="Buscar por descripción..."
                   @bind="TextoBusqueda" @bind:event="oninput" />
            <button class="btn btn-primary" @onclick="NuevoTipoProducto">
                <i class="bi bi-plus-circle"></i>
                <span>Nuevo</span>
            </button>
        </div>
    </div>

    @if (_tiposProducto == null)
    {
        <div class="tbl-state">
            <i class="bi bi-arrow-repeat spin"></i> Cargando tipos de producto...
        </div>
    }
    else if (!tiposProductoFiltrados.Any())
    {
        <div class="tbl-state">
            <i class="bi bi-inbox"></i> No se encontraron tipos de producto.
        </div>
    }
    else
    {
        <div class="tbl-wrapper">
            <table class="tbl table-striped table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Descripción</th>
                        <th class="tbl-actions">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var tipo in tiposProductoFiltrados)
                    {
                        <tr>
                            <td>@tipo.IdTipoProducto</td>
                            <td>@tipo.Descripcion</td>
                            <td class="tbl-actions">
                                <button class="btn-icon" title="Ver productos" @onclick="() => VerProductos(tipo)">
                                    <i class="bi bi-boxes"></i>
                                </button>
                                <button class="btn-icon" title="Editar" @onclick="() => Editar(tipo)">
                                    <i class="bi bi-pencil-square"></i>
                                </button>
                                <button class="btn-icon btn-icon-danger" title="Eliminar" @onclick="() => AbrirModalConfirmacion(tipo)">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

<ConfirmationModal Title="Confirmar Eliminación"
                   IsVisible="_mostrarModalConfirmacion"
                   OnConfirm="EliminarConfirmado"
                   OnCancel="CerrarModalConfirmacion"
                   IsProcessing="_isEliminando"
                   ConfirmButtonText="Eliminar">
    @if (_tipoProductoParaEliminar != null)
    {
        <p>
            ¿Estás seguro de que deseas eliminar el tipo de producto:
            <strong>@_tipoProductoParaEliminar.Descripcion</strong>?
        </p>
        <small class="text-muted d-block">
            (Si tiene productos asociados, no podrá eliminarse)
        </small>
    }
</ConfirmationModal>


@code {
    private List<TipoProductoDTO>? _tiposProducto;
    private List<TipoProductoDTO> tiposProductoFiltrados = new();
    private string? _mensaje;
    private bool _esError;

    private string _textoBusqueda = string.Empty;
    private string TextoBusqueda
    {
        get => _textoBusqueda;
        set { _textoBusqueda = value ?? string.Empty; AplicarFiltro(); }
    }

    private bool _mostrarModalConfirmacion = false;
    private bool _isEliminando = false;
    private TipoProductoDTO? _tipoProductoParaEliminar;

    protected override async Task OnInitializedAsync()
    {
        await CargarTiposProducto();
    }

    private async Task CargarTiposProducto()
    {
        _mensaje = null;
        _tiposProducto = null; // Forzar estado de carga
        try
        {
            _tiposProducto = await tipoProductoApiClient.GetAllAsync() ?? new();
            AplicarFiltro();
        }
        catch (Exception ex)
        {
            _mensaje = $"Error al cargar los tipos de producto: {ex.Message}";
            _esError = true;
            _tiposProducto = new(); // Evitar null reference
        }
        StateHasChanged();
    }

    private void AplicarFiltro()
    {
        if (_tiposProducto == null)
        {
            tiposProductoFiltrados = new();
            return;
        }

        if (string.IsNullOrWhiteSpace(TextoBusqueda))
        {
            tiposProductoFiltrados = _tiposProducto;
        }
        else
        {
            var f = TextoBusqueda.Trim();
            tiposProductoFiltrados = _tiposProducto
                .Where(p => (p.Descripcion ?? string.Empty).Contains(f, StringComparison.OrdinalIgnoreCase))
                .ToList();
        }
    }

    private void NuevoTipoProducto() => NavigationManager.NavigateTo("/tipo-producto/crear");
    private void Editar(TipoProductoDTO tipo) => NavigationManager.NavigateTo($"/tipo-producto/editar/{tipo.IdTipoProducto}");
    private void VerProductos(TipoProductoDTO tipo) => NavigationManager.NavigateTo($"/tipo-producto/{tipo.IdTipoProducto}/productos");

    private void AbrirModalConfirmacion(TipoProductoDTO tipo)
    {
        _tipoProductoParaEliminar = tipo;
        _mostrarModalConfirmacion = true;
        StateHasChanged();
    }

    private void CerrarModalConfirmacion()
    {
        if (_isEliminando) return;
        _mostrarModalConfirmacion = false;
        _tipoProductoParaEliminar = null;
        StateHasChanged();
    }

    private async Task EliminarConfirmado()
    {
        if (_tipoProductoParaEliminar is null) return;

        _isEliminando = true;
        _mensaje = null;

        try
        {
            // El ApiClient lanzará una excepción en caso de error (como conflicto 409)
            await tipoProductoApiClient.DeleteAsync(_tipoProductoParaEliminar.IdTipoProducto);

            // Si no hay excepción, la eliminación fue exitosa
            _tiposProducto?.RemoveAll(t => t.IdTipoProducto == _tipoProductoParaEliminar.IdTipoProducto);
            AplicarFiltro();
            _mensaje = "Tipo de producto eliminado correctamente.";
            _esError = false;
        }
        catch (Exception ex)
        {
            _mensaje = $"Error al eliminar: {ex.Message}";
            _esError = true;
        }
        finally
        {
            _isEliminando = false;
            CerrarModalConfirmacion();
            StateHasChanged();
        }
    }
}

